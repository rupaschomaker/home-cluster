apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: traefik
  namespace: traefik
spec:
  interval: 15m
  chart:
    spec:
      chart: traefik
      version: 27.0.14
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
  releaseName: traefik
  values:
    TZ: America/Chicago
    additionalArguments:
      - --serverstransport.insecureskipverify=true
      - --providers.kubernetesingress.allowexternalnameservices=true
    ingress:
      main:
        enabled: false
      integrations:
        traefik:
          enabled: true
          middlwares:
            - name: local
              namespace: traefik
            - name: bouncer
              namespace: traefik
          certManager:
            enabled: true
            certificateIssuer: rupa 
      hosts:
        - host: traefik.${MY_DOMAIN}
          paths:
            - path: /
              pathType: prefix
    middlewares:
      ipWhiteList:
        - name: local
          sourceRange:
            - 172.16.0.0/16
            - 172.17.0.0/16
            - 192.168.1.0/24
      bouncer:
        - name: bouncer
          enabled: true
          logLevel: INFO
          forwardedHeadersTrustedIPs: []
    logs:
      access:
        enabled: true
        enabledFilters: false
        fields:
          general:
            defaultmode: keep
          headers:
            defaultmode: keep
        filters:
          minduration: 10ms
          retryattempts: true
          statuscodes: 200,300-302
        format: common
      general:
        format: common
        level: INFO
    metrics:
      main:
        enabled: true
        endpoints:
          - path: /metrics
            port: metrics
        prometheusRule:
          enabled: true
        targetSelector: metrics
        type: servicemonitor
    middlewares:
      customResponseHeaders:
        - headers:
          - name: X-Source
            value: rupa.com
          name: rupa
    operator:
      register: true
    persistence:
      crowdsec-bouncer-tls:
        enabled: '{{ if .Values.middlewares.bouncer }}true{{ else }}false{{ end }}'
        expandObjectName: false
        mountPath: /etc/traefik/crowdsec-certs
        objectName: crowdsec-bouncer-tls
        type: secret
      plugins:
        enabled: true
        mountPath: /plugins-storage
        type: emptyDir
    podOptions:
      automountServiceAccountToken: true
    portalhook:
      enabled: true
    providers:
      kubernetesCRD:
        enabled: true
      kubernetesIngress:
        enabled: true
        publishedService:
          enabled: true
    rbac:
      main:
        clusterWide: true
        enabled: true
        primary: true
        rules:
          - apiGroups:
            - ""
            resources:
            - services
            - endpoints
            - secrets
            verbs:
            - get
            - list
            - watch
          - apiGroups:
            - extensions
            - networking.k8s.io
            resources:
            - ingresses
            - ingressclasses
            verbs:
            - get
            - list
            - watch
          - apiGroups:
            - extensions
            - networking.k8s.io
            resources:
            - ingresses/status
            verbs:
            - update
          - apiGroups:
            - traefik.containo.us
            - traefik.io
            resources:
            - middlewares
            - middlewaretcps
            - ingressroutes
            - traefikservices
            - ingressroutetcps
            - ingressrouteudps
            - tlsoptions
            - tlsstores
            - serverstransports
            verbs:
            - get
            - list
            - watch
    release_name: traefik
    resources: {}
    securityContext:
      container:
        UMASK: "0022"
        runAsGroup: 568
        runAsUser: 568
      pod:
        fsGroupChangePolicy: OnRootMismatch
    service:
      main:
        enabled: true
        type: LoadBalancer
      tcp:
        enabled: true
        ports:
          web:
            enabled: true
            port: 80
            protocol: http
            redirectTo: websecure
          websecure:
            enabled: true
            forwardedHeaders:
              enabled: false
              insecureMode: false
            port: 443
            protocol: https
            proxyProtocol:
              enabled: false
              insecureMode: false
          extwebsecure:
            enabled: true
            forwardedHeaders:
              enabled: false
            name: extwebsecure
            port: 444
            protocol: https
            proxyProtocol:
              enabled: false